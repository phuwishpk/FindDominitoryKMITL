from datetime import datetime
import pytz
import json
from flask import session
import random

# --- เก็บชื่อที่ถูกใช้แล้วทั้งหมด (ระดับ global) ---
used_names = set()

def format_as_bangkok_time(utc_dt):
    if not isinstance(utc_dt, datetime):
        return utc_dt
    bangkok_tz = pytz.timezone("Asia/Bangkok")
    bangkok_dt = utc_dt.replace(tzinfo=pytz.utc).astimezone(bangkok_tz)
    return bangkok_dt.strftime('%d/%m/%Y %H:%M:%S')


def from_json_string(json_string):
    if json_string:
        try:
            return json.loads(json_string)
        except (json.JSONDecodeError, TypeError):
            return None
    return None


def get_anonymous_name():
    """
    สร้างหรือดึงชื่อ anonymous จาก session พร้อมป้องกันชื่อซ้ำ
    """
    global used_names

    if 'anonymous_name' not in session:
        adjectives = [
            "นัก", "ผู้", "จอม", "เทพ", "เงา", "สาย", "ดวง", "เพชร", "ทอง", "เงิน",
            "เหล็ก", "ลม", "น้ำ", "ไฟ", "ฟ้า", "ภู", "เมฆ", "หมอก", "แสง", "ดาว",
            "อรุณ", "รัตน์", "ใจ", "กล้า", "ฝัน", "นิรันดร์", "อิสระ", "สุข", "ศักดิ์", "มิตร",
            "วายุ", "อาทิตย์", "จันทรา", "พายุ", "แสงดาว", "เงียบ", "ไว", "ซน", "ลึกลับ", "สงบ",
            "อ่อนโยน", "แข็งแกร่ง", "มืด", "สว่าง", "เจิด", "นุ่ม", "เย็น", "ร้อน", "สดใส", "ล่องหน",
            "อิสระชน", "กล้าหาญ", "ฝันดี", "เร้นลับ", "ขี้เล่น", "เงียบงัน", "มั่นใจ", "สุขใจ", "โอบอ้อม", "รื่นรมย์",
            "ดื้อ", "ขี้สงสัย", "ผู้ร่าเริง", "นักคิด", "นักฝัน", "นักสู้", "ผู้สร้าง", "นักอ่าน", "นักเขียน", "นักฟัง",
            "ผู้รัก", "ผู้เฝ้ามอง", "ผู้ค้นหา", "ผู้พิทักษ์", "ผู้สังเกต", "ผู้กล้า", "ผู้มองฟ้า", "ผู้ตามฝัน", "นักเดินทาง", "นักสะสม",
            "ผู้ผจญภัย", "ผู้โอบฟ้า", "นักสร้างฝัน", "นักปราชญ์", "นักส่องดาว", "ผู้ชื่นชม", "ผู้พเนจร", "ผู้เงียบ", "ผู้รักธรรมชาติ", "นักค้นพบ",
            "ผู้มองดาว", "นักรังสรรค์", "นักท่องแดน", "นักสร้างแรงบันดาลใจ", "นักสะท้อน", "นักไล่ล่า", "นักเร้นลับ", "นักหาความสุข", "ผู้ใฝ่รู้", "นักฟ้าใหม่"
        ]

        nouns = [
            "แสง", "ดาว", "ฟ้า", "หมอก", "ฝน", "ลม", "พายุ", "ไฟ", "น้ำ", "เมฆ",
            "ดิน", "หญ้า", "ขุนเขา", "ทะเล", "ป่า", "มิตร", "รอยยิ้ม", "เงา", "รัตติกาล", "รุ่งอรุณ",
            "นิรันดร์", "ความหวัง", "ขอบฟ้า", "ความฝัน", "สายหมอก", "ท้องฟ้า", "พลัง", "หัวใจ", "ชีวิต", "เส้นทาง",
            "ความสุข", "กาลเวลา", "ความทรงจำ", "จิตใจ", "แสงจันทร์", "เสียงเพลง", "ประกาย", "มโนภาพ", "แสงดาว", "ฟ้าใหม่",
            "ความงาม", "อรุณรุ่ง", "ความกล้า", "สันติ", "พลังใจ", "อาทิตย์", "จันทรา", "ทะเลทราย", "สายรุ้ง", "วายุ",
            "เสียงหัวเราะ", "แรงบันดาลใจ", "ความคิด", "ความรู้สึก", "สายฟ้า", "ดวงดาว", "อัญมณี", "ประกายไฟ", "ขุนพล", "นักรบ",
            "ปริศนา", "รอยเท้า", "เงียบงัน", "ขอบโลก", "อวกาศ", "จักรวาล", "โลกา", "พสุธา", "อาณาจักร", "นครา",
            "พงไพร", "ห้วงฝัน", "สายน้ำ", "มหาสมุทร", "ขอบฟ้าใหม่", "กวี", "พฤกษา", "สุริยัน", "จันทรา", "ทิพย์",
            "อัญชัน", "มรกต", "มณี", "ทิพยจักร", "เพลิง", "ดารา", "รัศมี", "ตะวัน", "ธารา", "คีตา",
            "นที", "กวีฝัน", "เมฆา", "โค้งฟ้า", "มหานที", "พรรณา", "พฤกษ์", "จิตวิญญาณ", "สายนที", "อรุณ"
        ]

        # --- สุ่มชื่อจนกว่าจะได้ชื่อที่ไม่ซ้ำ ---
        while True:
            random_name = f"{random.choice(adjectives)}{random.choice(nouns)}#{random.randint(1000, 9999)}"
            if random_name not in used_names:
                used_names.add(random_name)
                session['anonymous_name'] = random_name
                break

    return session['anonymous_name']
