{% extends 'owner/base.html' %}

{% block owner_content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 fw-bold mb-0">Owner Dashboard</h1>
  <div>
    {# --- vvv ส่วนที่เพิ่มเข้ามาใหม่ vvv --- #}
    <a class="btn btn-outline-secondary" href="{{ url_for('owner.trash') }}">
      <i data-feather="trash-2" class="me-1" style="width:16px;"></i> ถังขยะ
    </a>
    {# --- ^^^ สิ้นสุดการแก้ไข ^^^ --- #}
    <a class="btn btn-primary ms-2" href="{{ url_for('owner.new_property') }}">
      <i data-feather="plus" class="me-1" style="width:16px;"></i> สร้างประกาศใหม่
    </a>
  </div>
</div>

<div class="card">
  <div class="card-header">
    รายการประกาศของคุณ
  </div>
  <div class="list-group list-group-flush">
    {% for p in props %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div class="flex-grow-1">
        <a href="{{ url_for('owner.edit_property', prop_id=p.id) }}" class="text-decoration-none text-dark fw-semibold">{{ p.dorm_name }}</a>
        <div class="small text-muted">
          Workflow: 
            {% if p.workflow_status == 'approved' %}
                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Approved</span>
            {% elif p.workflow_status == 'submitted' %}
                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">Submitted</span>
            {% elif p.workflow_status == 'rejected' %}
                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Rejected</span>
            {% else %}
                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">Draft</span>
            {% endif %}
          
          <span class="ms-2">สถานะห้อง: 
            {% if p.availability_status == 'vacant' %}
              <span class="badge bg-success-subtle text-success-emphasis rounded-pill">ห้องว่าง</span>
            {% else %}
              <span class="badge bg-danger text-white rounded-pill">ห้องเต็ม</span>
            {% endif %}
          </span>
        </div>
      </div>
      
      <div class="d-flex align-items-center">
        <form method="post" action="{{ url_for('owner.toggle_availability', prop_id=p.id) }}" class="d-inline-block me-2" title="สลับสถานะห้องว่าง/เต็ม">
          {{ submit_form.csrf_token }}
          <button type="submit" class="btn btn-sm btn-outline-secondary">
            {% if p.availability_status == 'vacant' %}
              <i data-feather="moon" style="width:16px;"></i> ตั้งเป็น "ห้องเต็ม"
            {% else %}
              <i data-feather="sun" style="width:16px;"></i> ตั้งเป็น "ห้องว่าง"
            {% endif %}
          </button>
        </form>
      
        {% if p.workflow_status == 'draft' or p.workflow_status == 'rejected' %}
        <form method="post" action="{{ url_for('owner.submit_for_approval', prop_id=p.id) }}" class="d-inline-block me-2" onsubmit="return confirm('คุณต้องการส่งประกาศนี้เพื่อขออนุมัติใช่หรือไม่?');">
          {{ submit_form.csrf_token }} 
          <button class="btn btn-sm btn-outline-info">ส่งอนุมัติ</button>
        </form>
        {% endif %}
        <a href="{{ url_for('owner.edit_property', prop_id=p.id) }}" class="btn btn-sm btn-outline-secondary">
            <i data-feather="edit-2" style="width:16px;"></i> แก้ไข
        </a>
        
        {# --- vvv ส่วนที่เพิ่มเข้ามาใหม่ vvv --- #}
        <button type="button" class="btn btn-sm btn-outline-danger ms-2" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ p.id }}" title="ลบประกาศ">
            <i data-feather="trash" style="width:16px;"></i> ลบ
        </button>
        {# --- ^^^ สิ้นสุดการแก้ไข ^^^ --- #}

      </div>
    </div>
    {% else %}
    <div class="list-group-item text-center text-muted p-5">
      ยังไม่มีประกาศ
    </div>
    {% endfor %}
  </div>
</div>

{# --- vvv Modals สำหรับยืนยันการลบ vvv --- #}
{% for p in props %}
<div class="modal fade" id="deleteModal-{{ p.id }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ p.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel-{{ p.id }}">ยืนยันการลบ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        คุณต้องการย้ายประกาศ <strong>"{{ p.dorm_name }}"</strong> ไปยังถังขยะใช่หรือไม่?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        <form action="{{ url_for('owner.delete_property', prop_id=p.id) }}" method="POST">
            {{ delete_form.csrf_token }}
            <button type="submit" class="btn btn-danger">ยืนยันการลบ</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{# --- ^^^ สิ้นสุดการแก้ไข ^^^ --- #}

{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
      {% if category == 'script_command' and message == 'clear_form_storage' %}
        const storageKey = `fileStore_/owner/property/new`;
        sessionStorage.removeItem(storageKey);
        console.log('Form image storage cleared.');
      {% endif %}
    {% endfor %}
  {% endwith %}
});
</script>
{% endblock %}