<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Dorm Finder{% endblock %}</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.css"/>

  <style>
    :root {
      --bs-primary-rgb: 79, 170, 255;
      --bs-primary: #4FAAFF;
      --primary-color-deep: #4f46e5;
      --secondary-color: #f3f4f6;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8f9fa;
    }
    .admin-body, .owner-body { background-color: #F4F7FC; }
    .navbar-custom {
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 0.75rem 0;
    }
    .navbar-brand-custom {
        font-weight: 700; display: flex; align-items: center;
        gap: 0.5rem; color: #1a202c !important;
    }
    .navbar-brand-custom .icon-wrapper {
        background-color: var(--bs-primary); color: #fff; border-radius: 0.375rem;
        width: 32px; height: 32px; display: inline-flex;
        justify-content: center; align-items: center;
    }
    .nav-buttons .btn { font-weight: 500; border-radius: 0.5rem; }
    .main-full-screen-center {
        min-height: 100vh; display: flex; align-items: center; justify-content: center;
        padding: 1rem; background-color: var(--secondary-color);
        background-image: radial-gradient(at 47% 33%, hsl(205.00, 100%, 75%) 0, transparent 59%), 
                          radial-gradient(at 82% 65%, hsl(218.00, 89%, 60%) 0, transparent 55%);
    }
    .toast-container { z-index: 1100; }
    .toast-body {
        display: flex;
        align-items: center;
        font-weight: 500;
    }
    .toast-body .feather {
        margin-right: 0.75rem;
    }
  </style>
</head>
<body class="{% if request.path.startswith('/admin') %}admin-body{% elif request.path.startswith('/owner') %}owner-body{% endif %}">

{% if not request.path.startswith('/admin') and not request.path.startswith('/owner') and not request.path.startswith('/auth') %}
<nav class="navbar navbar-expand-lg navbar-custom sticky-top">
  <div class="container">
    <a class="navbar-brand-custom" href="{{ url_for('public.index') }}">
        <span class="icon-wrapper"><i data-feather="home" style="width: 18px; height: 18px;"></i></span>
        FindDorm KMITL
    </a>
    <div class="ms-auto nav-buttons d-flex align-items-center gap-2">
      {% if current_user.is_authenticated %}
        {% if current_user.role == 'admin' %}
          <a class="btn btn-primary btn-sm" href="{{ url_for('admin.dashboard') }}"><i data-feather="settings" class="me-1" style="width:16px;"></i>Admin Panel</a>
        {% elif current_user.role == 'owner' %}
          <a class="btn btn-primary btn-sm" href="{{ url_for('owner.dashboard') }}"><i data-feather="grid" class="me-1" style="width:16px;"></i>‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å</a>
        {% endif %}
        <form action="{{ url_for('auth.logout') }}" method="POST" class="d-inline">
            {{ empty_form.csrf_token }}
            <button type="submit" class="btn btn-outline-secondary btn-sm"><i data-feather="log-out" class="me-1" style="width:16px;"></i>Logout</button>
        </form>
      {% else %}
        <a class="btn btn-primary btn-sm" href="{{ url_for('auth.login') }}">Login</a>
      {% endif %}
    </div>
  </div>
</nav>
{% endif %}

{% set main_class = 'container py-4' %}
{% if request.path.startswith('/admin') or request.path.startswith('/owner') %}
    {% set main_class = 'w-100' %}
{% elif request.path.startswith('/auth') %}
    {% set main_class = 'main-full-screen-center' %}
{% endif %}

<main class="{{ main_class }}">
  {# --- vvv ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ include ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß vvv --- #}
  {% include '_shared/flashes.html' %}
  {# --- ^^^ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ^^^ --- #}
  {% block content %}{% endblock %}
</main>

<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet-geosearch@3.11.0/dist/geosearch.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
<script>
  // Global Toast Function, accessible from anywhere
  const toastContainer = document.querySelector('.toast-container');
  function createToast(message, category = 'info') {
      if (!toastContainer) return;
      const toastId = 'toast-' + Date.now();
      let icon = 'info';
      switch(category) {
          case 'success': icon = 'check-circle'; break;
          case 'danger': icon = 'x-circle'; break;
          case 'warning': icon = 'alert-triangle'; break;
          case 'primary': icon = 'bell'; break;
      }

      const toastHTML = `
          <div id="${toastId}" class="toast align-items-center text-bg-${category} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                  <div class="toast-body">
                      <i data-feather="${icon}"></i>
                      ${message}
                  </div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
          </div>`;
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      feather.replace({ width: '1.1em', height: '1.1em' }); // Render the icon
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, { delay: 10000 }); // ‡πÄ‡∏û‡∏¥‡πà‡∏° delay ‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      toast.show();
      toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
  }

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => feather.replace(), 50);

    // This part handles special toasts passed via session (e.g., after registration)
    {% with toast = session.pop('toast_message', None) %}
        {% if toast %}
            createToast("{{ toast['message'] | safe }}", "{{ toast['category'] }}");
        {% endif %}
    {% endwith %}

    {% if current_user.is_authenticated and current_user.role == 'admin' %}
        {% with admin_toast = session.pop('toast_admin_notification', None) %}
            {% if admin_toast %}
                createToast("{{ admin_toast['message'] | safe }}", "{{ admin_toast['category'] }}");
            {% endif %}
        {% endwith %}
    {% endif %}

    // --- vvv ‡πÄ‡∏û‡∏¥‡πà‡∏° Real-Time Listener vvv ---
    if (typeof io !== 'undefined') {
        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ SocketIO ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
        const socket = io(); 
        const isPublicPage = window.location.pathname === '/' || window.location.pathname.includes('/search');
        const isAdminDashboard = window.location.pathname.includes('/admin/dashboard') || window.location.pathname.includes('/admin/queue') || window.location.pathname.includes('/admin/owner_queue');
        const isOwnerDashboard = window.location.pathname.includes('/owner/dashboard');

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        function notifyAndReload(message, category = 'primary') {
            const reloadBtn = `<button onclick="window.location.reload()" class="btn btn-sm btn-light ms-2">‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>`;
            createToast(`${message} ${reloadBtn}`, category);
        }

        // Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Public/Owner/Admin)
        socket.on('property_updated', function(data) {
            let message = `üì¢ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ID ${data.id} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï`;
            let category = 'info';
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            if (data.status === 'approved') {
                message = `üéâ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß! (ID: ${data.id})`;
                category = 'success';
            } else if (data.status === 'rejected') {
                message = `‚ùå ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ID ${data.id} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Owner)`;
                category = 'danger';
            } else if (data.availability) {
                const status = data.availability === 'vacant' ? '‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á' : '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°';
                message = `üì¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å ID ${data.id} ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${status}`;
                category = 'primary';
            } else if (data.status === 'submitted') {
                message = `üîî ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà ID ${data.id} ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`;
                category = 'warning';
            } else if (data.status === 'deleted' || data.status === 'deleted_permanently') {
                message = `üóëÔ∏è ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® ID ${data.id} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin/Owner)`;
                category = 'secondary';
            }

            // ‡πÅ‡∏™‡∏î‡∏á Toast ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
            createToast(message, category);

            // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            if (isPublicPage && (data.status === 'approved' || data.status === 'deleted_permanently')) {
                notifyAndReload('‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏û‡∏±‡∏Å');
            } else if (isAdminDashboard && (data.status === 'approved' || data.status === 'submitted' || data.status === 'rejected')) {
                 notifyAndReload('‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏≠‡∏û‡∏±‡∏Å');
            } else if (isOwnerDashboard && (data.status === 'approved' || data.status === 'rejected' || data.availability || data.status === 'deleted' || data.status === 'deleted_permanently')) {
                 notifyAndReload('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á');
            }
        });
        
        // Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Dashboard/Queue ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        socket.on('admin_dashboard_update', function(data) {
            if (isAdminDashboard) {
                notifyAndReload('üìä ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥');
            }
        });

        // Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Owner Status (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Owner)
        socket.on('owner_status_changed', function(data) {
             let message = `üë§ Owner ID ${data.id} ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞`;
             let category = 'primary';
             if (data.status === 'approved') {
                 message = `‚úÖ Owner ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß (ID: ${data.id})`;
                 category = 'success';
             } else if (data.status === 'rejected') {
                 message = `‚ùå ‡∏Ñ‡∏≥‡∏Ç‡∏≠ Owner ID ${data.id} ‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò`;
                 category = 'danger';
             }

             createToast(message, category);

             if (isAdminDashboard) {
                notifyAndReload('ü§ù ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ Owner');
            } else if (data.status === 'approved' && !isPublicPage) {
                 // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤ Public ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏°‡∏µ Owner ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤
                 createToast(`ü§ù ‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß`, 'primary');
            }
        });
        
        // Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Master Data (‡πÄ‡∏ä‡πà‡∏ô Amenity)
        socket.on('master_data_updated', function(data) {
             if (isAdminDashboard || isPublicPage) {
                notifyAndReload('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï');
            }
        });
        
        // Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Review
        socket.on('review_updated', function(data) {
             if (isAdminDashboard) {
                notifyAndReload('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢ Admin');
            }
        });
        
    }
    // --- ^^^ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î Real-Time Listener ^^^
  });
</script>

{% block page_scripts %}{% endblock %}

</body>
</html>
