{% extends 'base.html' %}


{% block content %}
<div class="container my-5">
    <a href="{{ url_for('public.index') }}" class="btn btn-sm btn-outline-secondary mb-3">← กลับสู่หน้าหลัก</a>
    
    {% if not prop %}
    <div class="alert alert-danger">ไม่พบประกาศนี้ หรือประกาศยังไม่ได้รับการอนุมัติ</div>
    {% else %}

    <div class="row">
        
        <div class="col-lg-8">
            <div class="d-flex align-items-center mb-3">
                <h1 class="mb-0">{{ prop.dorm_name }}</h1>
                {% if prop.availability_status == 'vacant' %}
                    <span class="badge bg-success fs-6 ms-3">ห้องว่าง</span>
                {% else %}
                    <span class="badge bg-danger text-white fs-6 ms-3">ห้องเต็ม</span>
                {% endif %}
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">รายละเอียดหอพัก</h5>
                    <p class="card-text"><strong>ประเภทห้อง:</strong> {{ ROOM_TYPES.get(prop.room_type, prop.room_type) }}</p>
                    <p class="card-text"><strong>คำอธิบายเพิ่มเติม:</strong> {{ prop.additional_info or 'ไม่มีข้อมูลเพิ่มเติม' }}</p>
                    
                    <h6 class="mt-3">ราคาและค่าบริการ</h6>
                    <ul class="list-unstyled">
                        <li><strong>ค่าเช่าต่อเดือน:</strong> {{ "{:,.0f}".format(prop.rent_price) if prop.rent_price is not none else 'N/A' }} บาท</li>
                        <li><strong>เงินประกัน:</strong> {{ "{:,.0f}".format(prop.deposit_amount) if prop.deposit_amount is not none else 'N/A' }} บาท</li>
                        <li><strong>ค่าน้ำ/ค่าไฟ:</strong> น้ำ {{ prop.water_rate or 'N/A' }} / ไฟ {{ prop.electric_rate or 'N/A' }}</li>
                    </ul>

                    <h6 class="mt-3">สิ่งอำนวยความสะดวก</h6>
                    {% if prop.amenities.all() %}
                        {% for amenity in prop.amenities %}
                            <span class="badge bg-info text-dark me-2 mb-1">{{ amenity.label_th }}</span>
                        {% endfor %}
                    {% else %}
                        <p>ไม่พบข้อมูลสิ่งอำนวยความสะดวก</p>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">รีวิวและคะแนนเฉลี่ย</h5>
                    <p>
                        <strong>คะแนนเฉลี่ย:</strong> 
                        {% if avg_rating > 0 %}
                            {{ "%.1f"|format(avg_rating) }} / 5.0
                        {% else %}
                            ยังไม่มีคะแนน
                        {% endif %}
                    </p>
                    <hr>
                    <h6 class="mt-3">แสดงความคิดเห็น</h6>

                    <form method="POST" action="">
                       {{ form.hidden_tag() }}

                       <div class="mb-2">
                         {{ form.rating.label(class="form-label") }}
                         {{ form.rating(class="form-select") }}
                         {% for e in form.rating.errors %}
                         <div class="text-danger small">{{ e }}</div>
                         {% endfor %}
                       </div>

                       <div class="mb-3">
                         {{ form.comment.label(class="form-label") }}
                         {{ form.comment(class="form-control", rows=3, placeholder="พิมพ์ความคิดเห็นของคุณ...") }}
                         {% for e in form.comment.errors %}
                         <div class="text-danger small">{{ e }}</div>
                         {% endfor %}
                       </div>

                       {{ form.submit(class="btn btn-primary") }}
                   </form>

                    <hr>
                    <h6 class="mt-3">ความคิดเห็นทั้งหมด ({{ reviews|length }})</h6>
                    {% for review in reviews %}
                    <div class="card bg-light mb-2">
                        <div class="card-body">
                            <p class="card-text">{{ review.comment }}</p>
                            <footer class="blockquote-footer">
                                ให้คะแนน <span class="badge bg-warning text-dark">{{ review.rating }} ดาว</span>
                            </footer>
                        </div>
                    </div>
                    {% else %}
                    <p>ยังไม่มีความคิดเห็น</p>
                    {% endfor %}
                </div>
            </div>

        </div>

        <div class="col-lg-4">
            <div class="card sticky-top shadow-lg" style="top: 20px;">
                <div class="card-body">
                    <h5 class="card-title text-success">ติดต่อสอบถาม</h5>
                    <p class="mb-2"><strong>โทรศัพท์:</strong> <a href="tel:{{ prop.contact_phone }}">{{ prop.contact_phone or 'N/A' }}</a></p>
                    <p class="mb-2"><strong>LINE ID:</strong> {{ prop.line_id or 'N/A' }}</p>
                    <p class="mb-2"><strong>Facebook:</strong> <a href="{{ prop.facebook_url }}" target="_blank">{{ prop.facebook_url or 'N/A' }}</a></p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
