<!DOCTYPE html><html lang="th"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Public Map</title>
<style>
html,body{height:100%;margin:0}#map{height:100%;width:100%}
.card{position:absolute;top:12px;left:12px;z-index:2;background:rgba(15,23,42,.9);color:#e6edf3;padding:10px 12px;border-radius:12px;border:1px solid #223;backdrop-filter:blur(6px);font-family:system-ui,Segoe UI,Roboto,Arial}
.card input{background:#0b1220;color:#e6edf3;border:1px solid #233;border-radius:8px;padding:8px;width:180px}
.card button{padding:8px 10px;border-radius:8px;border:1px solid #334;background:#1f2637;color:#dbeafe;cursor:pointer}
</style></head>
<body>
<div class="card">
  <strong>Public Map</strong><br/><small>โหลดหมุดจาก /api/markers</small><br/>
  <div style="margin-top:6px;display:flex;gap:6px;align-items:center;">
    <input id="category" placeholder="กรอง category (เช่น school)"/>
    <button id="btnFilter">Filter</button>
    <button id="btnReset">Reset</button>
  </div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js" defer></script>
<script>
let map, clusterer, markers=[];
async function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{center:{lat:13.7563,lng:100.5018},zoom:7,mapTypeControl:false});
  await loadAndRender();
  document.getElementById("btnFilter").onclick=loadAndRender;
  document.getElementById("btnReset").onclick=async()=>{document.getElementById("category").value=""; await loadAndRender();}
}
function clearMarkers(){ if(clusterer) clusterer.clearMarkers(); markers.forEach(m=>m.setMap(null)); markers=[]; }
function escapeHtml(s){return s? s.replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])):"";}
async function loadAndRender(){
  clearMarkers();
  const cat=document.getElementById("category").value.trim();
  const url=new URL(location.origin+"/api/markers"); if(cat) url.searchParams.set("category",cat); url.searchParams.set("active_only","true");
  const res=await fetch(url); const data=await res.json();
  data.forEach(item=>{
    const marker=new google.maps.Marker({position:{lat:item.lat,lng:item.lng}, map, title:item.title, icon:item.icon_url||undefined});
    const info=new google.maps.InfoWindow({content:`<div style="min-width:220px"><strong>${escapeHtml(item.title)}</strong><br/>
      ${item.category?`<small style="color:#64748b">${escapeHtml(item.category)}</small><br/>`:""}
      ${item.description?`<div style="margin-top:6px">${escapeHtml(item.description)}</div>`:""}</div>`});
    marker.addListener("click",()=>info.open({anchor:marker,map})); markers.push(marker);
  });
  if(window.markerClusterer&&markers.length>0){ clusterer=new markerClusterer.MarkerClusterer({map,markers}); }
  if(markers.length>0){ const b=new google.maps.LatLngBounds(); markers.forEach(m=>b.extend(m.getPosition())); map.fitBounds(b); }
}
</script>
<script defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&v=weekly&callback=initMap"></script>
</body></html>
